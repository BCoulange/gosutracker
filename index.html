<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="Webpage description goes here" />
  <meta charset="utf-8">
  <title>Gosu X Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-umd-min.js"></script>
</head>

<body>


<script type="module">
  import { h, render } from 'https://esm.sh/preact';
  
  import htm from 'https://esm.sh/htm';
  import { useState, useEffect } from 'https://esm.sh/preact/hooks';

  const clans_classes = {
    "Xi'an":"xian",
    "Narashima":"narashima",
    "Abhilasha":"abhilasha",
    "Galmi":"galmi",
    "Tomorrow":"tomorrow",
    "Goan-Sul":"goan-sul",
    "Justice":"justice",
    "Phoenix":"phoenix",
    "Abunakkashii":"abunakkashii"
  }


  function p1VictoryPct(data){
    const totElements = data.length;
    const p1wins = _.select(data,(d) => _.select(d["players"],(el) => el["is_first_player"])[0]["is_winner"]).length
    return parseInt(parseFloat(p1wins)/totElements*100)
  }

  // Initialize htm with Preact
  const html = htm.bind(h);

  function Clan (props) {
    const p1pct = p1VictoryPct(props.hypothesisData)

    return html `
      <div class="box ${props.clan_class} ${props.visible ? '' : "hidden"}">
        <div class="flex-row">
          <div>
            ${props.all_clans_selected ? '' : html `<button onClick=${(e) => props.selectClan(props.clan_name)}>select</button>`}
          </div>
          <div>
            ${props.ban_selected ? '' : html`<button onClick=${(e) => props.selectBan(props.clan_name)}>ban</button>`}            
          </div>
          <div>
            ${props.passives_selected ? '' : html `<button onClick=${(e) => props.selectPassive(props.clan_name)}>passive</button>`}
          </div>
        </div>
        <h1>${props.clan_name}</h1>
        <table class="victory-stat-table">
          <tr>
            <th>P1</th>
            <th>P2</th>
          </tr>
          <tr>
            <td>${p1pct}%</td>
            <td>${100-p1pct}%</td>
          </tr>
          <tr>
            <td colspan="2">
              <small><i>
                ${props.hypothesisData.length} games (${parseInt(parseFloat(props.hypothesisData.length)/props.datasetSize*100)}%)
              </i></small>
            </td>
          </tr>
          <tr>
              <small><i>
                ${props.hypothesisPassive === undefined ? '' : 
                  html `Passive in ${props.hypothesisPassive.length} (${parseInt(parseFloat(props.hypothesisPassive.length)/props.datasetSize*100)}%)`
                }
              </i></small>
          </tr>
        </table>        
      </div>
    `    
  }

  function filterData({data,clanBanned,minElo,clansSelected,passives}){
    return _.filter(data,(el) => {
      return (el["average_rank"] >= minElo)
        && ((clanBanned.length === 0) || _.isEqual(clanBanned,el["clans_banned"]))
        && ((clansSelected[0] === undefined) || (el["clans_selected"][0] === clansSelected[0]))
        && ((clansSelected[1] === undefined) || (el["clans_selected"][1] === clansSelected[1]) || (el["clans_selected"][2] === clansSelected[1]))
        && ((clansSelected[2] === undefined) || (el["clans_selected"][1] === clansSelected[2]) || (el["clans_selected"][2] === clansSelected[2]))
        && ((clansSelected[3] === undefined) || (el["clans_selected"][3] === clansSelected[3]) || (el["clans_selected"][4] === clansSelected[3]))
        && ((clansSelected[4] === undefined) || (el["clans_selected"][3] === clansSelected[4]) || (el["clans_selected"][4] === clansSelected[4]))
        && ((clansSelected[5] === undefined) || (el["clans_selected"][5] === clansSelected[5]))
        && ((passives[0] === undefined) || (el["clan_passives"].indexOf(passives[0])) >= 0)
        && ((passives[1] === undefined) || (el["clan_passives"].indexOf(passives[1])) >= 0)
    })
  }

  function App (props) {
    const [minElo,setMinElo] = useState(0)
    const [selectedData,setSelectedData] = useState([])
    const [allData,setAllData] = useState([])
    const [datasetELO, setDatasetELO] = useState({min: 0, max: 100})
    const [clanBanned,setClanBanned] = useState([])
    const [clansSelected,setClanSelected] = useState([undefined,undefined,undefined,undefined,undefined,undefined])
    const [passives,setPassives] = useState([])

    function removePassive(clan_name){
      setPassives(passives.filter((el) => el !== clan_name))
    }

    function addClanToSelection(clan_name){
      const nextIndex = clansSelected.indexOf(undefined)
      let newClans = [...clansSelected]
      newClans[nextIndex] = clan_name
      return newClans   
    }
    function selectClan(clan_name){
      setClanSelected(addClanToSelection(clan_name))
    }
    function removeClan(clan_name){
      let newClans = [...clansSelected]
      const i = clansSelected.indexOf(clan_name)
      newClans[i] = undefined
      setClanSelected(newClans)
    }
    function ClanSelected({clan_name, removeClan}){
      if(clan_name === undefined){
        return html`<div></div>`
      }else{
        return html `<div class="box ${clans_classes[clan_name]}">
          ${clan_name}
          <button onClick=${(e) => removeClan(clan_name)}>remove</button>
        </div>`
      }        
    }


    useEffect(async () => {
      const response = await fetch("data.json");
      setAllData(await response.json());
    },[])
    useEffect(() => {
      setSelectedData(filterData({data:allData,clanBanned,minElo,clansSelected,passives}))
      setDatasetELO({
        min: _.min(_.map(allData, (el) => el["average_rank"])),
        max: _.max(_.map(allData, (el) => el["average_rank"]))
      })
    }, [allData,minElo,clanBanned,clansSelected,passives])

    return html`
      <div class="nice flex-row">
        <div>
          Number of games: ${selectedData.length} / ${allData.length}
        </div>
        <div class="flex-row">
          <div>
            ELO > ${minElo}
          </div>
          <div class="slidecontainer">
            <input 
              type="range" 
              min="${datasetELO.min}" 
              max="${datasetELO.max}" 
              value="${minElo}" 
              class="slider" 
              onInput=${(e) => {setMinElo(e.currentTarget.value)}}
              />
          </div>
        </div>
      </div>
<div class="container flex-row">
  <div class="flex-column left-panel nice">
    ${_.map(_.groupBy([
        {clan_class:"xian",clan_name: "Xi'an"},
        {clan_class:"narashima",clan_name: "Narashima"},
        {clan_class:"abhilasha",clan_name: "Abhilasha"},
        {clan_class:"galmi",clan_name: "Galmi"},
        {clan_class:"tomorrow",clan_name: "Tomorrow"},
        {clan_class:"goan-sul",clan_name: "Goan-Sul"},
        {clan_class:"justice",clan_name: "Justice"},
        {clan_class:"phoenix",clan_name: "Phoenix"},
        {clan_class:"abunakkashii",clan_name: "Abunakkashii"}
      ], (el,i) => parseInt(i/4)), (g) => {
      console.log(g)
      return html`<div class="flex-row nice">
        ${g.map((el) => html`
        <${Clan} 
          clan_class=${el.clan_class} 
          clan_name=${el.clan_name}
          ban_selected=${clanBanned.length > 0} 
          selectBan=${(c) => setClanBanned([c])}
          selectClan=${(c) => selectClan(c)}
          visible=${
            (clanBanned.indexOf(el.clan_name) < 0) 
            && (clansSelected.indexOf(el.clan_name) < 0)
            && (passives.indexOf(el.clan_name) < 0)
          }
          hypothesisData=${filterData({data:selectedData,clanBanned,minElo,clansSelected:addClanToSelection(el.clan_name),passives})}
          hypothesisPassive=${
            passives.length === 2 ? 
              undefined :
              filterData({data:selectedData,clanBanned,minElo,clansSelected,passives:[...passives,el.clan_name]})
          }
          all_clans_selected=${clansSelected.indexOf(undefined) < 0}
          datasetSize=${selectedData.length}
          passives_selected=${passives.length === 2}
          selectPassive=${(c) => setPassives([...passives,c])}
        />
      `)}
      </div>`
    })}
  </div>
  <div class="right-panel flex-col nice">
    <div class="flex-row">
      <div id="first-player-picks" class="flex-column nice">
        <div>
          <h1>P1</h1>
          <p>${p1VictoryPct(selectedData)}% WIN</p>
        </div>
        <div id="first-player-pick1" class="flex-column border">
          <${ClanSelected} clan_name=${clansSelected[0]} removeClan=${removeClan}/>         
        </div>
        <div id="first-player-pick2" class="flex-column border grow-2">
          <${ClanSelected} clan_name=${clansSelected[3]} removeClan=${removeClan}/>         
          <${ClanSelected} clan_name=${clansSelected[4]} removeClan=${removeClan}/>         
        </div>
      </div>
      <div id="second-player-picks" class="flex-column nice">
        <div>
          <h1>P2</h1>
          <p>${100-p1VictoryPct(selectedData)}% WIN</p>
        </div>
        <div id="second-player-pick1" class="flex-column border grow-2">
          <${ClanSelected} clan_name=${clansSelected[1]} removeClan=${removeClan}/>         
          <${ClanSelected} clan_name=${clansSelected[2]} removeClan=${removeClan}/>         
        </div>
        <div id="second-player-pick2" class="flex-column border">
          <${ClanSelected} clan_name=${clansSelected[5]} removeClan=${removeClan}/>         
        </div>
      </div>
    </div>
    <div>
      <h3>Banned</h3>
      ${clanBanned.map((clan_name) => {
        return html`
          <div class="box ${clans_classes[clan_name]}">
            ${clan_name}
            <button onClick=${(e) => setClanBanned([])}>Unban</button>
          </div>   
        `
      })}
    </div>
    <div>
      <h3>Victory conditions</h3>
      <ul>
        ${_.map(
            _.sortBy(
              _.map(
                _.groupBy(
                  selectedData,
                  (d) => d.victory_condition
                ), 
                (v,k) => {
                  return {nb: v.length, name: k}
                }
              ), 
              (el) => - el.nb
            ), 
            (el) => {
              return html`<li> ${el.name} : ${parseInt(parseFloat(el.nb)/selectedData.length*100)}% (${el.nb}) </li>`
            }
        )}
      </ul>
    </div>
    <div>
      <h3>Passives</h3>
      <div class="flex-row">
        ${passives.map((clan_name) => {
          return html`
            <div class="box ${clans_classes[clan_name]}">
              ${clan_name}
              <button onClick=${(e) => removePassive(clan_name)}>remove</button>
            </div>   
          `
        })}
      </div>
    </div>

  </div>
</div>

    `;
  }

  render(html`<${App} name="World" />`, document.body);
</script>
</body>
</html>