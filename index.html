<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="Webpage description goes here" />
  <meta charset="utf-8">
  <title>Gosu X Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-umd-min.js"></script>
</head>

<body>


<script type="module">
  import { h, render } from 'https://esm.sh/preact';
  
  import htm from 'https://esm.sh/htm';
  import { useState, useEffect } from 'https://esm.sh/preact/hooks';

  const optimal_computation_min_dataset_size = 4

  const clans_classes = {
    "Xi'an":"xian",
    "Narashima":"narashima",
    "Abhilasha":"abhilasha",
    "Galmi":"galmi",
    "Tomorrow":"tomorrow",
    "Goan-Sul":"goan-sul",
    "Justice":"justice",
    "Phoenix":"phoenix",
    "Abunakkashii":"abunakkashii"
  }

  function optimal_6th_clan_draft(data,current_selection){
    const dataset = _.select(data,(d) => {
      return (d["clans_selected"][0] === current_selection[0]) 
        && ((d["clans_selected"][1] === current_selection[1]) || (d["clans_selected"][2] === current_selection[1]))
        && ((d["clans_selected"][1] === current_selection[2]) || (d["clans_selected"][2] === current_selection[2]))
        && ((d["clans_selected"][3] === current_selection[3]) || (d["clans_selected"][4] === current_selection[3]))
        && ((d["clans_selected"][3] === current_selection[4]) || (d["clans_selected"][4] === current_selection[4]))
    })
    const trials = _.filter(_.map(_.groupBy(dataset, (d) => d["clans_selected"][5]),(g,sixth_clan) => {
      const v = p1VictoryPct(g)
      return {
        clan_name: sixth_clan,
        selection_size: g.length,
        pct_p1_victory: v
      }
    }),(el) => el["selection_size"] > optimal_computation_min_dataset_size)

    if(trials.length < 1){
      return undefined
    }else{
      // max victory P2
      return _.sortBy(trials,(el) => -(100-el["pct_p1_victory"]))[0]
    }
  }
  function optimal_45th_clan_draft(data,current_selection){
    const dataset = _.select(data,(d) => {
      return (d["clans_selected"][0] === current_selection[0]) 
        && ((d["clans_selected"][1] === current_selection[1]) || (d["clans_selected"][2] === current_selection[1]))
        && ((d["clans_selected"][1] === current_selection[2]) || (d["clans_selected"][2] === current_selection[2]))
    })
    const trials = _.filter(_.map(_.groupBy(dataset, (d) => [d["clans_selected"][3],d["clans_selected"][4]].sort()),(g,fourfifth_clan) => {
      const v = p1VictoryPct(g)
      return {
        fourfifth_clan: fourfifth_clan.split(","),
        best_scenario: optimal_6th_clan_draft(g,[...current_selection,...fourfifth_clan.split(",")])
      }
    }),(el) => el["best_scenario"] !== undefined)

    if(trials.length < 1){
      return undefined
    }else{
      // max victory P2
      return _.sortBy(trials,(el) => -(el["best_scenario"]["pct_p1_victory"]))[0] // max P1 victory
    }
  }
  function optimal_23th_clan_draft(data,current_selection){
    const dataset = _.select(data,(d) => {
      return (d["clans_selected"][0] === current_selection[0]) 
    })
    const trials = _.filter(_.map(_.groupBy(dataset, (d) => [d["clans_selected"][1],d["clans_selected"][2]].sort()),(g,secondthird_clan) => {
      const v = p1VictoryPct(g)
      return {
        secondthird_clan: secondthird_clan.split(","),
        best_scenario: optimal_45th_clan_draft(g,[...current_selection,...secondthird_clan.split(",")])
      }
    }),(el) => el["best_scenario"] !== undefined)

    if(trials.length < 1){
      return undefined
    }else{
      // max victory P2
      return _.sortBy(trials,(el) => -(100-el["best_scenario"]["best_scenario"]["pct_p1_victory"]))[0] // max P1 victory
    }
  }

  function optimal_1st_clan_draft(data){
    const trials = _.filter(_.map(_.groupBy(data, (d) => d["clans_selected"][0]),(g,first_clan) => {
      const v = p1VictoryPct(g)
      return {
        first_clan: first_clan,
        best_scenario: optimal_23th_clan_draft(g,[first_clan])
      }
    }),(el) => el["best_scenario"] !== undefined)

    if(trials.length < 1){
      return undefined
    }else{
      // max victory P2
      return _.sortBy(trials,(el) => -(100-el["best_scenario"]["best_scenario"]["best_scenario"]["pct_p1_victory"]))[0] // max P1 victory
    }
  }  

  function p1VictoryPct(data){
    const totElements = data.length;
    const p1wins = _.select(data,(d) => _.select(d["players"],(el) => el["is_first_player"])[0]["is_winner"]).length
    return parseInt(parseFloat(p1wins)/totElements*100)
  }

  // Initialize htm with Preact
  const html = htm.bind(h);

  function OptimalDraft(props){
    if (props.clansSelected[0] === undefined){
      // draft with no knowledge
      const res = optimal_1st_clan_draft(props.data)
      if (res === undefined){
        return html`<div>No optimal draft in data</div>`
      }else{
        return html `<table class="nice-table">
          <tr>
            <th></th>
            <th>P1</th>
            <th>P2</th>
          </tr>
          <tr>
            <td colspan="3">
              <i>
                ${res["best_scenario"]["best_scenario"]["best_scenario"]["selection_size"]} games
              </i>
            </td>
          </tr>
          <tr>
            <td>Win</td>
            <td>${res["best_scenario"]["best_scenario"]["best_scenario"]["pct_p1_victory"]}%</td>
            <td>${100-res["best_scenario"]["best_scenario"]["best_scenario"]["pct_p1_victory"]}%</td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["first_clan"]]}">${res["first_clan"]}</td>
            <td class="nice ${clans_classes[res["best_scenario"]["secondthird_clan"][0]]}">
              ${res["best_scenario"]["secondthird_clan"][0]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["best_scenario"]["best_scenario"]["fourfifth_clan"][0]]}">
              ${res["best_scenario"]["best_scenario"]["fourfifth_clan"][0]}
            </td>
            <td class="nice ${clans_classes[res["best_scenario"]["secondthird_clan"][1]]}">
              ${res["best_scenario"]["secondthird_clan"][1]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["best_scenario"]["best_scenario"]["fourfifth_clan"][1]]}">
              ${res["best_scenario"]["best_scenario"]["fourfifth_clan"][1]}
            </td>
            <td class="nice ${clans_classes[res["best_scenario"]["best_scenario"]["best_scenario"]["clan_name"]]}">
              ${res["best_scenario"]["best_scenario"]["best_scenario"]["clan_name"]}
            </td>
          </tr>
        </table>`
      }
    }else if ((props.clansSelected[1] === undefined) || (props.clansSelected[2] === undefined)){
      // draft with already one clan
      const res = optimal_23th_clan_draft(props.data,[props.clansSelected[0]])
      if (res === undefined){
        return html`<div>No optimal draft in data</div>`
      }else{
        return html `<table class="nice-table">
          <tr>
            <th></th>
            <th>P1</th>
            <th>P2</th>
          </tr>
          <tr>
            <td colspan="3">
              <i>
                ${res["best_scenario"]["best_scenario"]["selection_size"]} games
              </i>
            </td>
          </tr>
          <tr>
            <td>Win</td>
            <td>${res["best_scenario"]["best_scenario"]["pct_p1_victory"]}%</td>
            <td>${100-res["best_scenario"]["best_scenario"]["pct_p1_victory"]}%</td>
          </tr>          
          <tr>
            <td></td>
            <td class="nice ${clans_classes[props.clansSelected[0]]}">${props.clansSelected[0]}</td>
            <td class="nice ${clans_classes[res["secondthird_clan"][0]]}">
              ${res["secondthird_clan"][0]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["best_scenario"]["fourfifth_clan"][0]]}">
              ${res["best_scenario"]["fourfifth_clan"][0]}
            </td>
            <td class="nice ${clans_classes[res["secondthird_clan"][1]]}">
              ${res["secondthird_clan"][1]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["best_scenario"]["fourfifth_clan"][1]]}">
              ${res["best_scenario"]["fourfifth_clan"][1]}
            </td>
            <td class="nice ${clans_classes[res["best_scenario"]["best_scenario"]["clan_name"]]}">
              ${res["best_scenario"]["best_scenario"]["clan_name"]}
            </td>
          </tr>
        </table>`
      }
    }else if ((props.clansSelected[3] === undefined) || (props.clansSelected[4] === undefined)){
      // draft with 3 clans already picked
      const res = optimal_45th_clan_draft(props.data,[props.clansSelected[0],props.clansSelected[1],props.clansSelected[2]])
      if (res === undefined){
        return html`<div>No optimal draft in data</div>`
      }else{
        return html `<table class="nice-table">
          <tr>
            <th></th>
            <th>P1</th>
            <th>P2</th>
          </tr>
          <tr>
            <td colspan="3">
              <i>
                ${res["best_scenario"]["selection_size"]} games
              </i>
            </td>
          </tr>
          <tr>
            <td>Win</td>
            <td>${res["best_scenario"]["pct_p1_victory"]}%</td>
            <td>${100-res["best_scenario"]["pct_p1_victory"]}%</td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[props.clansSelected[0]]}">${props.clansSelected[0]}</td>
            <td class="nice ${clans_classes[props.clansSelected[1]]}">
              ${props.clansSelected[1]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["fourfifth_clan"][0]]}">
              ${res["fourfifth_clan"][0]}
            </td>
            <td class="nice ${clans_classes[props.clansSelected[2]]}">
              ${props.clansSelected[2]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[res["fourfifth_clan"][1]]}">
              ${res["fourfifth_clan"][1]}
            </td>
            <td class="nice ${clans_classes[res["best_scenario"]["clan_name"]]}">
              ${res["best_scenario"]["clan_name"]}
            </td>
          </tr>
        </table>`
      }
    }else if (props.clansSelected[5] === undefined){
      // draft with 5 clans selected
      const res = optimal_6th_clan_draft(props.data,[props.clansSelected[0],props.clansSelected[1],props.clansSelected[2],props.clansSelected[3],props.clansSelected[4]])
      if (res === undefined){
        return html`<div>No optimal draft in data</div>`
      }else{
        return html `<table class="nice-table">
          <tr>
            <th></th>
            <th>P1</th>
            <th>P2</th>
          </tr>
          <tr>
            <td colspan="3">
              <i>
                ${res["selection_size"]} games
              </i>
            </td>
          </tr>
          <tr>
            <td>Win</td>
            <td>${res["pct_p1_victory"]}%</td>
            <td>${100-res["pct_p1_victory"]}%</td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[props.clansSelected[0]]}">${props.clansSelected[0]}</td>
            <td class="nice ${clans_classes[props.clansSelected[1]]}">
              ${props.clansSelected[1]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[props.clansSelected[3]]}">
              ${props.clansSelected[3]}
            </td>
            <td class="nice ${clans_classes[props.clansSelected[2]]}">
              ${props.clansSelected[2]}
            </td>
          </tr>
          <tr>
            <td></td>
            <td class="nice ${clans_classes[props.clansSelected[4]]}">
              ${props.clansSelected[4]}
            </td>
            <td class="nice ${clans_classes[res["clan_name"]]}">
              ${res["clan_name"]}
            </td>
          </tr>
        </table>`
      }
    }else{
      return ""
    }
  }

  function Clan (props) {
    const p1pct = p1VictoryPct(props.hypothesisData)

    return html `
      <div class="box ${props.clan_class} ${props.visible ? '' : "hidden"}">
        <div class="flex-row">
          <div>
            ${props.all_clans_selected ? '' : html `<button onClick=${(e) => props.selectClan(props.clan_name)}>select</button>`}
          </div>
          <div>
            ${props.ban_selected ? '' : html`<button onClick=${(e) => props.selectBan(props.clan_name)}>ban</button>`}            
          </div>
          <div>
            ${props.passives_selected ? '' : html `<button onClick=${(e) => props.selectPassive(props.clan_name)}>passive</button>`}
          </div>
        </div>
        <h1>${props.clan_name}</h1>
        <p>If next pick :</p1>
        <table class="nice-table">
          <tr>
            <th></th>
            <th>P1</th>
            <th>P2</th>
          </tr>
          <tr>
            <td>win</td>
            <td>${p1pct}%</td>
            <td>${100-p1pct}%</td>
          </tr>
          <tr>
            <td colspan="3">
              <small><i>
                picked in ${props.hypothesisData.length} games (${parseInt(parseFloat(props.hypothesisData.length)/props.datasetSize*100)}%)
              </i></small>
            </td>
          </tr>
          <tr>
            <td colspan="3">
              <small><i>
                ${props.hypothesisPassive === undefined ? '' : 
                  html `Passive in ${props.hypothesisPassive.length} (${parseInt(parseFloat(props.hypothesisPassive.length)/props.datasetSize*100)}%)`
                }
              </i></small>
            </td>
          </tr>
        </table>        
      </div>
    `    
  }

  function filterData({data,clanBanned,minElo,clansSelected,passives}){
    return _.filter(data,(el) => {
      return (el["average_rank"] >= minElo)
        && ((clanBanned.length === 0) || _.isEqual(clanBanned,el["clans_banned"]))
        && ((clansSelected[0] === undefined) || (el["clans_selected"][0] === clansSelected[0]))
        && ((clansSelected[1] === undefined) || (el["clans_selected"][1] === clansSelected[1]) || (el["clans_selected"][2] === clansSelected[1]))
        && ((clansSelected[2] === undefined) || (el["clans_selected"][1] === clansSelected[2]) || (el["clans_selected"][2] === clansSelected[2]))
        && ((clansSelected[3] === undefined) || (el["clans_selected"][3] === clansSelected[3]) || (el["clans_selected"][4] === clansSelected[3]))
        && ((clansSelected[4] === undefined) || (el["clans_selected"][3] === clansSelected[4]) || (el["clans_selected"][4] === clansSelected[4]))
        && ((clansSelected[5] === undefined) || (el["clans_selected"][5] === clansSelected[5]))
        && ((passives[0] === undefined) || (el["clan_passives"].indexOf(passives[0])) >= 0)
        && ((passives[1] === undefined) || (el["clan_passives"].indexOf(passives[1])) >= 0)
    })
  }

  function App (props) {
    const [minElo,setMinElo] = useState(100)
    const [selectedData,setSelectedData] = useState([])
    const [allData,setAllData] = useState([])
    const [datasetELO, setDatasetELO] = useState({min: 0, max: 500})
    const [clanBanned,setClanBanned] = useState([])
    const [clansSelected,setClanSelected] = useState([undefined,undefined,undefined,undefined,undefined,undefined])
    const [passives,setPassives] = useState([])

    function removePassive(clan_name){
      setPassives(passives.filter((el) => el !== clan_name))
    }

    function addClanToSelection(clan_name){
      const nextIndex = clansSelected.indexOf(undefined)
      let newClans = [...clansSelected]
      newClans[nextIndex] = clan_name
      return newClans   
    }
    function selectClan(clan_name){
      setClanSelected(addClanToSelection(clan_name))
    }
    function removeClan(clan_name){
      let newClans = [...clansSelected]
      const i = clansSelected.indexOf(clan_name)
      newClans[i] = undefined
      setClanSelected(newClans)
    }
    function ClanSelected({clan_name, removeClan}){
      if(clan_name === undefined){
        return html`<div></div>`
      }else{
        return html `<div class="box ${clans_classes[clan_name]}">
          ${clan_name}
          <button onClick=${(e) => removeClan(clan_name)}>remove</button>
        </div>`
      }        
    }


    useEffect(async () => {
      const response = await fetch("data.json");
      setAllData(await response.json());
    },[])
    useEffect(() => {
      setSelectedData(filterData({data:allData,clanBanned,minElo,clansSelected,passives}))
      setDatasetELO({
        min: _.min(_.map(allData, (el) => el["average_rank"])),
        max: _.max(_.map(allData, (el) => el["average_rank"]))
      })

        // console.log(optimal_6th_clan_draft(allData,["Abhilasha","Xi'an","Galmi","Narashima","Tomorrow"]))
      // console.log(optimal_45th_clan_draft(allData,["Abhilasha","Xi'an","Galmi"]))
      // console.log(optimal_23th_clan_draft(allData,["Abhilasha"]))
      console.log(optimal_1st_clan_draft(allData))

    }, [allData,minElo,clanBanned,clansSelected,passives])

    return html`
      <div class="nice flex-row">
        <div>
          Number of games: ${selectedData.length} / ${allData.length}
          <a class="nice" href="/data.csv" download="data.csv">
            CSV
          </a>
          <a class="nice" href="/data.json" download="data.json">
            JSON
          </a>
        </div>
        <div class="flex-row">
          <div>
            ELO > ${minElo}
          </div>
          <div class="slidecontainer">
            <input 
              type="range" 
              min="${datasetELO.min}" 
              max="${datasetELO.max}" 
              value="${minElo}" 
              class="slider" 
              onInput=${(e) => {setMinElo(e.currentTarget.value)}}
              />
          </div>
        </div>
      </div>
<div class="container flex-row">
  <div class="flex-column left-panel nice">
    ${_.map(_.groupBy([
        {clan_class:"xian",clan_name: "Xi'an"},
        {clan_class:"narashima",clan_name: "Narashima"},
        {clan_class:"abhilasha",clan_name: "Abhilasha"},
        {clan_class:"galmi",clan_name: "Galmi"},
        {clan_class:"tomorrow",clan_name: "Tomorrow"},
        {clan_class:"goan-sul",clan_name: "Goan-Sul"},
        {clan_class:"justice",clan_name: "Justice"},
        {clan_class:"phoenix",clan_name: "Phoenix"},
        {clan_class:"abunakkashii",clan_name: "Abunakkashii"}
      ], (el,i) => parseInt(i/3)), (g) => {
      return html`<div class="flex-row nice">
        ${g.map((el) => {
          if(el ===undefined){
            return html`<div></div>`
          }else{
            return html`
            <${Clan} 
              clan_class=${el.clan_class} 
              clan_name=${el.clan_name}
              ban_selected=${clanBanned.length > 0} 
              selectBan=${(c) => setClanBanned([c])}
              selectClan=${(c) => selectClan(c)}
              visible=${
                (clanBanned.indexOf(el.clan_name) < 0) 
                && (clansSelected.indexOf(el.clan_name) < 0)
                && (passives.indexOf(el.clan_name) < 0)
              }
              hypothesisData=${filterData({data:selectedData,clanBanned,minElo,clansSelected:addClanToSelection(el.clan_name),passives})}
              hypothesisPassive=${
                passives.length === 2 ? 
                  undefined :
                  filterData({data:selectedData,clanBanned,minElo,clansSelected,passives:[...passives,el.clan_name]})
              }
              all_clans_selected=${clansSelected.indexOf(undefined) < 0}
              datasetSize=${selectedData.length}
              passives_selected=${passives.length === 2}
              selectPassive=${(c) => setPassives([...passives,c])}
            />`
          }
        })}
      </div>`
    })}
  </div>
  <div class="right-panel flex-col nice">
    <div class="flex-row">
      <div id="first-player-picks" class="flex-column nice">
        <div>
          <h1>P1</h1>
          <p>${p1VictoryPct(selectedData)}% WIN</p>
        </div>
        <div id="first-player-pick1" class="flex-column border  min-100">
          <${ClanSelected} clan_name=${clansSelected[0]} removeClan=${removeClan}/>         
        </div>
        <div id="first-player-pick2" class="flex-column border grow-2  min-200">
          <${ClanSelected} clan_name=${clansSelected[3]} removeClan=${removeClan}/>         
          <${ClanSelected} clan_name=${clansSelected[4]} removeClan=${removeClan}/>         
        </div>
      </div>
      <div id="second-player-picks" class="flex-column nice">
        <div>
          <h1>P2</h1>
          <p>${100-p1VictoryPct(selectedData)}% WIN</p>
        </div>
        <div id="second-player-pick1" class="flex-column border grow-2 min-200">
          <${ClanSelected} clan_name=${clansSelected[1]} removeClan=${removeClan}/>         
          <${ClanSelected} clan_name=${clansSelected[2]} removeClan=${removeClan}/>         
        </div>
        <div id="second-player-pick2" class="flex-column border  min-100">
          <${ClanSelected} clan_name=${clansSelected[5]} removeClan=${removeClan}/>         
        </div>
      </div>
    </div>
    <div>
      <h3>Banned</h3>
      ${clanBanned.map((clan_name) => {
        return html`
          <div class="box ${clans_classes[clan_name]}">
            ${clan_name}
            <button onClick=${(e) => setClanBanned([])}>Unban</button>
          </div>   
        `
      })}
    </div>
    <div>
      <h3>Victory conditions</h3>
      <ul>
        ${_.map(
            _.sortBy(
              _.map(
                _.groupBy(
                  selectedData,
                  (d) => d.victory_condition
                ), 
                (v,k) => {
                  return {nb: v.length, name: k}
                }
              ), 
              (el) => - el.nb
            ), 
            (el) => {
              return html`<li> ${el.name} : ${parseInt(parseFloat(el.nb)/selectedData.length*100)}% (${el.nb}) </li>`
            }
        )}
      </ul>
    </div>
    <div>
      <h3>Passives</h3>
      <div class="flex-row">
        ${passives.map((clan_name) => {
          return html`
            <div class="box ${clans_classes[clan_name]}">
              ${clan_name}
              <button onClick=${(e) => removePassive(clan_name)}>remove</button>
            </div>   
          `
        })}
      </div>
    </div>
    <div>
      <h3>Optimal Draft</h3>
      <${OptimalDraft} data=${selectedData} clansSelected=${clansSelected} />
    </div>
  </div>
</div>

    `;
  }

  render(html`<${App} name="World" />`, document.body);
</script>
</body>
</html>